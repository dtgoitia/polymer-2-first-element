<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../promise-polyfill/promise-polyfill-lite.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<!-- bower install --save PolymerLabs/iron-ajax -->
<!-- bower install --save PolymerLabs/promise-polyfill -->
<link rel="import" href="./filter/car-filter.html">
<link rel="import" href="./results/car-list.html">

<dom-module id="my-app">
  <template>
    <custom-style>
      <style>
        :host {
          --app-primary-color: #4285f4;
          --app-primary-background-color: #FFFFFF;
          --app-secondary-color: rgba(0, 0, 0, 0.8);
          --app-secondary-background-color: #AAAAAA;

          display: block;
          margin: 0 auto;
          padding-bottom: 4em;
          width: 95vw;
          min-height: 100vh;
          /* overflow: scroll; */
          overflow: visible;
          background-color: var(--app-secondary-background-color);
          font-family: 'Roboto', 'Noto', sans-serif;
        }

        .header {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          color: var(--app-primary-color);
          background-color: var(--app-primary-background-color);
          font-size: 2.2em;
          padding: 0.9em 1.3em 0.8em;
          border-bottom: 1.5px solid var(--app-secondary-color);
          z-index: 1000;
        }

        .content {
          color: var(--app-secondary-color);
          margin: 0 auto 0 auto;
          padding-top: 9em;
          max-width: 1300px;

          display: flex;
          flex-direction: row;
          flex-wrap: nowrap;
          justify-content: center;
          align-items: flex-start;
        }
      </style>
    </custom-style>

    <iron-ajax
      auto
      url={{url}}
      handle-as="json"
      on-response="_carsLoaded"
      debounce-duration="300"
    ></iron-ajax>

    <div class="header" onclick={{tempShowResults}}>Cars Co.</div>
    <div id="content" class="content">
      <template is="dom-if" if={{filterData}}>
        <car-filter update-results={{updateResults}} filter-data={{filterData}}></car-filter>
        <car-list data={{results}}></car-list>
      </template>
    </div>
  </template>

  <script>
    class MyApp extends Polymer.Element {
      static get is() { return "my-app"}
      static get properties() {
        return {
          acceptedFilterKeys: {
            type: Array,
            value: ['price', 'make', 'year']
          },
          filterData: {
            type: Object,
            observer: 'filterDataChanged'
          },
          firstLoad: {
            type: Boolean,
            value: true
          },
          results: {
            type: Array,
            value: []
          },
          url: {
            type: String,
            value: 'http://localhost:3000/api/cars'
          }
        }
      }

      constructor() {
        super();
        this.updateResults = this.updateResults.bind(this);
        this.callUpdateResults = this.callUpdateResults.bind(this);
      }

      filterDataChanged(newValue, oldValue) {
        console.log('MyApp.filterDataChanged()');
        // console.log('  this.filterData', this.filterData);
        console.log('  newValue', newValue);
        console.log('  oldValue', oldValue);
      }

      getSingleUrlParameterFromFilterData(data, key) {
        // console.log('getSingleUrlParameterFromFilterData');
        // console.log('  data:', data);
        // console.log('  key:', key);
        // console.log('  data[' + key + ']:', data[key]);
        const values = [];
        // filterData[key].map(entry => entry.check ? values.push(entry[key]) : null);
        
        const dataValues = data[key];
        // console.log('  dataValues:', dataValues);
        // console.log('  dataValues[0]:', dataValues[0]);
        dataValues.map(entry => {
          // console.log('  entry:', entry);
          // console.log('  entry.check:', entry.check);
          return entry.check ? values.push(entry[key]) : null
        });
        // console.log('getSingleUrlParameterFromFilterData\n  values:', values);
        if ( values.length > 0 ) {
          const valuesString = values.join(',');
          // console.log('  valuesString:', valuesString);
          return valuesString;
        } else {
          return null;
        }
      }

      getAllUrlParametersFromFilterData(data) {

        // console.log('MyApp.getAllUrlParametersFromFilterData()\ndata:', data);
        let url = '/api/cars';
        const filterDataTrimmed = {};
        filterDataTrimmed.make = this.getSingleUrlParameterFromFilterData(data, 'make');
        filterDataTrimmed.year = this.getSingleUrlParameterFromFilterData(data, 'year');
        filterDataTrimmed.price = data.price.price.toString();

        // console.log('getAllUrlParametersFromFilterData.filterDataTrimmed()\nthis.filterData:', this.filterData);
        // console.log('getAllUrlParametersFromFilterData.filterDataTrimmed()\nfilterDataTrimmed:', filterDataTrimmed);

        // console.log('serializeQueryObject(filterDataTrimmed):', this.serializeQueryObject(filterDataTrimmed));
        return '/api/cars?' + this.serializeQueryObject(filterDataTrimmed);
      }

      serializeQueryObject(queryObject) {
        const parameterArray = [];
        Object.getOwnPropertyNames(queryObject).map(key => {
          const value = queryObject[key];
          if ( value !== null) {
            let valueString;
            if (Array.isArray(value)) {
              valueString = value.join(',');
            }
            valueString
              ? parameterArray.push(key + '=' + valueString)
              : parameterArray.push(key + '=' + value)
          }
        })
        return encodeURI(parameterArray.join('&'));
      }

      updateResults() {
        setTimeout(this.callUpdateResults, 0);
        // this.callUpdateResults()
      }
      callUpdateResults() {
        // console.log('MyApp.updateResults() called');
        // console.log('MyApp.updateResults():\nthis.filterData', this.filterData);
        console.log('callUpdateResults() called');
        const currentFilterData = Object.assign(this.filterData);
        // console.log('MyApp.updateResults():\ncurrentFilterData', currentFilterData);
        const urlParameters = this.getAllUrlParametersFromFilterData(currentFilterData);
        const newUrl = 'http://localhost:3000' + urlParameters;
        console.log('MyApp.callUpdateResults()\nnewUrl', newUrl);
        this.set('url', newUrl);
        // console.log('MyApp.updateResults():\nnewUrl', newUrl);
      }

      getValuesPerKey(objectArray, key) {
        const allMakesNoRepeat = [];
        
        // Get all values associated to passed key
        const allValues = objectArray.map((object, i) => {
          return object.hasOwnProperty(key) ? object[key] : null;
        });
        
        // Eliminate duplicated values
        allValues.map(value => {
          if (value !== null && allMakesNoRepeat.includes(value) === false ) {
            allMakesNoRepeat.push(value);
          }
        });

        return allMakesNoRepeat.length > 0 ? allMakesNoRepeat : null;
      }

      getPriceFilterData(priceArray) {
        const maxPrice = priceArray.reduce((pre, cur) => {
          return Math.max(pre, cur);
        });
        return { max: maxPrice, price: maxPrice, step: 1000 };
      }

      getMakeFilterData(makeArray) {
        return(
          makeArray.map(make => {
            return { make: make, check: false };
          })
        );
      }

      getYearFilterData(yearArray) {
        return(
          yearArray.map(make => {
            return { year: make, check: false };
          })
        );
      }

      getAvailableFilterData(availableData) {
        const availableFilterData = {};
        this.acceptedFilterKeys.map(key => {
          const values = this.getValuesPerKey(availableData, key);
          availableFilterData[key] = values;
        });

        const returnObject = {};
        const priceFilterData = availableFilterData.price ? this.getPriceFilterData(availableFilterData.price) : null;
        // console.log('priceFilterData', priceFilterData);
        const makeFilterData = availableFilterData.make ? this.getMakeFilterData(availableFilterData.make) : null;
        // console.log('makeFilterData', makeFilterData);
        const yearFilterData = availableFilterData.year ? this.getYearFilterData(availableFilterData.year) : null;
        // console.log('yearFilterData', yearFilterData);
        priceFilterData !== null ? returnObject.price = priceFilterData : null;
        makeFilterData !== null ? returnObject.make = makeFilterData : null;
        yearFilterData !== null ? returnObject.year = yearFilterData : null;
        
        // console.log('MyApp.getAvailableFilterData():\nreturnObject:', returnObject);

        return returnObject;
      }

      // ready() {
      //   super.ready();
      //   console.log('MyApp.ready()');
      // }

      _carsLoaded(e) {
        console.log('MyApp._carsLoaded()')
        const data = e.detail.response;
        // console.log('MyApp._carsLoaded()\nreceived data:', data);
        // console.log('MyApp.filterData:', this.filterData);
        if (this.firstLoad) {
          this.set('filterData', this.getAvailableFilterData(data));
          console.log('MyApp._carsLoaded() > filterData updated');
          this.set('results', data);
          console.log('MyApp._carsLoaded() > results updated');
          this.set('firstLoad', false);
          console.log('MyApp._carsLoaded() > firstLoad updated');
        } else {
          this.set('results', data);
          console.log('MyApp._carsLoaded() > results updated');
          // console.log('this.results:', this.results);
        }
        // console.log('MyApp.filterData:', this.filterData);
        // console.log('MyApp.filterData updated');
      }

      /*  1. On load, fetch all cars
          2. Get all available makes, prices and years for the filter data
          3. Call API with desired data:
            3.1. write function to: filterData => urlParameters
            - If all make or year are false, show all (only apply price filter)
      */
    }
    
    customElements.define(MyApp.is, MyApp);
  </script>
</dom-module>
